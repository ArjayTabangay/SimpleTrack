@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Routing
@inject ParcelTracking.Web.Services.AuthService AuthService
@inject NavigationManager Navigation

@code {
    [Parameter]
    public RouteData? RouteData { get; set; }

    [Parameter]
    public Type? DefaultLayout { get; set; }

    private bool _shouldRenderRoute;
    private bool _redirectAttempted;

    protected override void OnParametersSet()
    {
        _shouldRenderRoute = IsPublicRoute() || AuthService.IsAuthenticated;
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (!_shouldRenderRoute && !_redirectAttempted)
        {
            _redirectAttempted = true;
            var returnUrl = Uri.EscapeDataString(Navigation.Uri);
            Navigation.NavigateTo($"/login?returnUrl={returnUrl}");
        }
    }

    private bool IsPublicRoute()
    {
        var relative = Navigation.ToBaseRelativePath(Navigation.Uri).Split('?')[0];
        if (string.IsNullOrEmpty(relative))
            return true; // root is public
        if (relative.StartsWith("login", StringComparison.OrdinalIgnoreCase))
            return true; // login page is public
        return false;
    }
}

@if (_shouldRenderRoute)
{
    <RouteView RouteData="RouteData" DefaultLayout="DefaultLayout" />
}
else
{
    <div></div>
}
